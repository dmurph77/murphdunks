<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MurphDunks</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
  <header class="navbar">
    <div class="container nav-container">
      <div class="branding">
        <a href="index.html" class="brand-link">MurphDunks</a>
      </div>
      <div class="nav-links">
        <div style="flex: 1;">
          <a href="faq.html">FAQ</a>
          <a href="progress.html">Progress</a>
          <a href="about.html">About</a> &nbsp;
        </div>
        <div id="navTotals" style="flex-shrink: 0;">
          Total Donations: $<span id="totalBets" style="color: yellow">0</span>&nbsp;Charity: $<span id="charityAmount" style="color: yellow">0</span>
        </div>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="container hero-container">
      <h1>Will Murph Dunk or Run a Sub 3:10 Marathon?</h1>
      <p>Choose your side. 80% of the proceeds to the winning side. 20% for charity.</p>
      <a href="javascript:void(0);" id="down-arrow" onclick="scrollToBetting()">↓</a>
    </div>
  </section>

  <section class="betting-section" id="betting">
    <div class="container betting-container">
      <div class="bet-box">
        <h2>Will Murph Dunk?</h2>
        <div class="bet-stats">
          <p><div>$ For: $<span id="dunkFor">0</span></div></p>
          <p><div>$ Against: $<span id="dunkAgainst">0</span></div></p>
          <p><div>Implied Odds: <span id="dunkOdds">0%</span></div></p>
        </div>
        <canvas id="dunkChart" width="300" height="150" style="margin-top: 10px;"></canvas>        
        <input type="number" id="amountInputDunk" placeholder="Enter Amount ($)" min="1" step="1" style="margin-right: 10px; margin-top: 10px; padding: 8px; font-size: 1rem; background-color: black; color: white; border: 1px solid white;">
        <div class="bet-buttons">
          <button class="buy-button" onclick="openBetModal(document.getElementById('amountInputDunk').value, 'for', 'dunk')">Buy $DUNK</button>
          <button class="sell-button" onclick="openBetModal(document.getElementById('amountInputDunk').value, 'against', 'dunk')">Sell $DUNK</button>
        </div>
      </div>

      <div class="bet-box">
        <h2>Will Murph Run a 3:10 Marathon?</h2>
        <div class="bet-stats">
          <p><div>$ For: $<span id="marathonFor">0</span></div></p>
          <p><div>$ Against: $<span id="marathonAgainst">0</span></div></p>
          <p><div>Implied Odds: <span id="marathonOdds">0%</span></div></p>
        </div>
        <canvas id="marathonChart" width="300" height="150" style="margin-top: 10px;"></canvas>        
        <input type="number" id="amountInputMarathon" placeholder="Enter Amount ($)" min="1" step="1" style="margin-right: 10px; margin-top: 10px; padding: 8px; font-size: 1rem; background-color: black; color: white; border: 1px solid white;">
        <div class="bet-buttons">
          <button class="buy-button" onclick="openBetModal(document.getElementById('amountInputMarathon').value, 'for', 'marathon')">Buy $CHI262 </button>
          <button class="sell-button" onclick="openBetModal(document.getElementById('amountInputMarathon').value, 'against', 'marathon')">Sell $CHI262 </button>
        </div>
      </div>

        <!-- Charity Donation Section -->
<section id="charity-donation" style="background-color:black; color:white; text-align:center">
  <h2 style="margin-bottom:20px;">Want to Support Without Picking a Side?</h2>
  <a href="https://secure.e2rm.com/p2p/fundraising/391023/participant/5513984/en-CA" target="_blank" style="background:yellow; color:black; padding:15px 25px; border-radius:8px; font-weight:bold; text-decoration:none; font-size:1.1rem;">
    Support my Run with Misericordia
  </a>
</section>

    </div>

    <section id="twitter-feed" style="background-color:black; color:white; text-align:center; padding:30px;">
      <h2 style="margin-bottom:20px;">Follow the Journey</h2>
      <a class="twitter-timeline" href="https://twitter.com/murphdunks?ref_src=twsrc%5Etfw">Tweets by murphdunks</a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </section>

    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

    <footer style="text-align: center; margin-top: 50px; padding: 20px; font-size: 1.1rem; color: white;">
      <p style="margin-bottom: 10px;">
        <a href="https://github.com/dmurph77/murphdunks" target="_blank" style="margin: 0 10px; color: yellow;">
          <i class="fab fa-github"></i>
        </a>
        <a href="https://twitter.com/murphdunks target="_blank" style="margin: 0 10px; color: yellow;">
          <i class="fab fa-x-twitter"></i> <!-- or use fa-twitter if you prefer -->
        </a>
        <a href="https://www.strava.com/athletes/108903657" target="_blank" style="margin: 0 10px; color: yellow;">
          <i class="fab fa-strava"></i>
        </a>
      </p>
      <p style="font-size: 0.9rem; color: gray;">
        © 2025 MurphDunks. All rights reserved.
      </p>
    </footer>

    <!-- Bet Modal -->
<div id="betModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:black; border:1px solid white; padding:30px; border-radius:8px; max-width:400px; width:90%; text-align:center; color:white;">
    <h2 id="betModalTitle" style="color:yellow"></h2>
    <p style="color: white; margin-bottom: 20px; font-size: 0.9rem; text-align:left">
      You’ll be securely redirected to Stripe for payment after filling this form.
    </p>

    <input id="firstNameInput" type="text" placeholder="First Name" style="width:90%; margin:8px; padding:8px; background-color: black; color: white; border: 1px solid white;"><br>
    <input id="lastNameInput" type="text" placeholder="Last Name" style="width:90%; margin:8px; padding:8px; background-color: black; color: white; border: 1px solid white;"><br>
    <input id="emailInput" type="email" placeholder="Email" style="width:90%; margin:8px; padding:8px; background-color: black; color: white; border: 1px solid white;"><br>
    <input id="venmoHandleInput" type="text" placeholder="Venmo Handle" style="width:90%; margin:8px; padding:8px; background-color: black; color: white; border: 1px solid white;"><br>
    <input id="messageInput" type="text" placeholder="Optional Message" style="width:90%; margin:8px; padding:8px; background-color: black; color: white; border: 1px solid white;"><br>

    <div style="margin-top:15px; color:gray;">
      <input type="checkbox" id="tweetConsent" checked>
      <label for="tweetConsent" style="font-size:0.9rem;">Post my bet and message to @murphdunks on Twitter ($$ not shown). We want to see the support/trash talk!</label>
    </div>

    <button onclick="confirmBet()" style="margin-top:10px; padding:10px 20px; background:yellow; color:black; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">Confirm Bet</button><br><br>
    <button onclick="closeBetModal()" style="color:white; background:none; border:none; margin-top:5px; cursor:pointer;">Cancel</button>
  </div>
</div>

<script>
  async function loadStats() {
    try {
      const apiBaseUrl = window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1')
      ? 'http://localhost:5000'
      : '';

      const response = await fetch(`${apiBaseUrl}/api/bets`);
      const data = await response.json();
  
      if (data.success) {
        const stats = data.stats;
  
        // Dunk stats
        animateValue('dunkFor', Number(document.getElementById('dunkFor').innerText), stats.dunk.for);
        animateValue('dunkAgainst', Number(document.getElementById('dunkAgainst').innerText), stats.dunk.against);
        document.getElementById('dunkOdds').innerText = (stats.dunk.impliedOdds * 100).toFixed(1) + '%';

        animateValue('marathonFor', Number(document.getElementById('marathonFor').innerText), stats.marathon.for);
        animateValue('marathonAgainst', Number(document.getElementById('marathonAgainst').innerText), stats.marathon.against);
        document.getElementById('marathonOdds').innerText = (stats.marathon.impliedOdds * 100).toFixed(1) + '%';

        animateValue('totalBets', Number(document.getElementById('totalBets').innerText), stats.totalBets);
        animateValue('charityAmount', Number(document.getElementById('charityAmount').innerText), stats.charityAmount); 
      }
    } catch (error) {
      console.error('Error loading stats:', error);
    }
  }
  
  window.onload = () => {
    loadStats();
    setInterval(loadStats, 10000); // refresh every 10 seconds
  };

  function animateValue(id, start, end, duration = 1000, isPercent = false) {
  const obj = document.getElementById(id);
  const range = end - start;
  const increment = range / (duration / 10);
  let current = start;
  const step = () => {
    current += increment;
    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
      current = end;
    }
    if (isPercent) {
      obj.innerText = Math.round(current) + '%';
    } else {
      obj.innerText = Math.round(current);
    }
    if (current !== end) {
      setTimeout(step, 10);
    }
  };
  step();
}

  </script>

<script>
  let currentAmount = 0;
  let currentSide = '';
  let currentEvent = '';
  
  function openBetModal(amount, side, event) {
    currentAmount = Math.round(amount);
    currentSide = side;
    currentEvent = event;
  
    document.getElementById('betModalTitle').innerText = `Confirm: $${currentAmount} ${side.toUpperCase()} ${event.toUpperCase()}`;
    document.getElementById('betModal').style.display = 'flex';
  }
  
  function closeBetModal() {
    document.getElementById('betModal').style.display = 'none';
  }
  
  async function confirmBet() {
    const firstName = document.getElementById('firstNameInput').value.trim();
    const lastName = document.getElementById('lastNameInput').value.trim();
    const email = document.getElementById('emailInput').value.trim();
    const venmoHandle = document.getElementById('venmoHandleInput').value.trim();
    const message = document.getElementById('messageInput').value.trim();
    const tweetConsent = document.getElementById('tweetConsent').checked;

    if (!validateEmail(email)) {
      alert('Please enter a valid email address.');
      return;
    }

    function validateEmail(email) {
      const re = /\S+@\S+\.\S+/;
      return re.test(email);
    }
  
    if (!firstName || !lastName || !email || !venmoHandle) {
      alert('Please fill out all required fields.');
      return;
    }
  
    try {
      const response = await fetch('http://localhost:5000/api/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: currentAmount,
          side: currentSide,
          event: currentEvent,
          firstName,
          lastName,
          email,
          venmoHandle,
          message,
          tweetConsent 
        })
      });
  
      const data = await response.json();
      window.location.href = data.url;
    } catch (error) {
      console.error('Checkout error:', error);
    }
  }
  </script>

<script>
  function scrollToBetting() {
    const bettingSection = document.getElementById('betting');
    const offset = 80; // Adjust this depending on your sidebar height
  
    const bodyRect = document.body.getBoundingClientRect().top;
    const elementRect = bettingSection.getBoundingClientRect().top;
    const elementPosition = elementRect - bodyRect;
  
    const offsetPosition = elementPosition - offset;
  
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
  </script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Setup for Dunk Chart
const ctxDunk = document.getElementById('dunkChart').getContext('2d');
const dunkOddsChart = new Chart(ctxDunk, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Dunk Implied Odds (%)',
      data: [],
      borderColor: 'yellow',
      backgroundColor: 'rgba(255,255,0,0.2)',
      fill: true,
      tension: 0.3
    }]
  },
  options: {
    scales: {
      y: { min: 0, max: 100, ticks: { color: 'white' } },
      x: { ticks: { color: 'white' } }
    },
    plugins: {
      legend: { display: false }
    }
  }
});

// Setup for Marathon Chart
const ctxMarathon = document.getElementById('marathonChart').getContext('2d');
const marathonOddsChart = new Chart(ctxMarathon, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Marathon Implied Odds (%)',
      data: [],
      borderColor: 'yellow',
      backgroundColor: 'rgba(255,255,0,0.2)',
      fill: true,
      tension: 0.3
    }]
  },
  options: {
    scales: {
      y: { min: 0, max: 100, ticks: { color: 'white' } },
      x: { ticks: { color: 'white' } }
    },
    plugins: {
      legend: { display: false }
    }
  }
});

async function fetchAndUpdateOddsCharts() {
  try {
    const response = await fetch('http://localhost:5000/api/bets');
    const raw = await response.json();
    const bets = raw.bets;

    console.log('Fetched Bets:', bets);

    // --- Build Dunk Chart Data ---
    const dunkBets = bets
      .filter(bet => bet.event === 'dunk')
      .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

    let dunkFor = 0;
    let dunkAgainst = 0;
    const dunkImpliedOddsHistory = [];
    const dunkLabels = [];

    dunkBets.forEach((bet, index) => {
      if (bet.side === 'for') dunkFor += bet.amount;
      else if (bet.side === 'against') dunkAgainst += bet.amount;

      const total = dunkFor + dunkAgainst;
      const impliedOdds = total > 0 ? (dunkFor / total) * 100 : 50;
      dunkImpliedOddsHistory.push(impliedOdds.toFixed(1));
      dunkLabels.push(`Bet ${index + 1}`);
    });

    dunkOddsChart.data.labels = dunkLabels;
    dunkOddsChart.data.datasets[0].data = dunkImpliedOddsHistory;
    dunkOddsChart.update();

    // --- Build Marathon Chart Data ---
    const marathonBets = bets
      .filter(bet => bet.event === 'marathon')
      .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

    let marathonFor = 0;
    let marathonAgainst = 0;
    const marathonImpliedOddsHistory = [];
    const marathonLabels = [];

    marathonBets.forEach((bet, index) => {
      if (bet.side === 'for') marathonFor += bet.amount;
      else if (bet.side === 'against') marathonAgainst += bet.amount;

      const total = marathonFor + marathonAgainst;
      const impliedOdds = total > 0 ? (marathonFor / total) * 100 : 50;
      marathonImpliedOddsHistory.push(impliedOdds.toFixed(1));
      marathonLabels.push(`Bet ${index + 1}`);
    });
    console.log('Raw Response:', bets);

    marathonOddsChart.data.labels = marathonLabels;
    marathonOddsChart.data.datasets[0].data = marathonImpliedOddsHistory;
    marathonOddsChart.update();

  } catch (error) {
    console.error('Error fetching bets or updating charts:', error);
  }
}
fetchAndUpdateOddsCharts();
</script>

</body>
</html>
